<?php

add_shortcode('list_sites', 'mism_list_sites');

function mism_list_sites($atts)
{
    $atts = shortcode_atts(
            array(
                'type' => 'active',
                'title' => '',
            ), $atts, 'list_sites' );
    
    $html = '';
    
    if($atts['type']=="active")
    {
        
        $blogs = get_blogs_of_user(get_current_user_id(),false);
        $html .= '<div class="tng-responsive-table">';
        $html .= '<table>';
        if(count($blogs)>0)
        {
            $html .= '<h3>'.$atts['title'].'</h3>';
            
            $html .= '<thead class="site-list-container">';
                $html .= '<th class="numeric">'.__('Sr. No.','mism').'</th>';
                $html .= '<th class="numeric">'.__('Site Name','mism').'</th>';
                $html .= '<th class="numeric">'.__('Site URL','mism').'</th>';
                $html .= '<th class="numeric">'.__('Action','mism').'</th>';
            $html .= '</thead>';
            
            $html .= '<tbody>';
                $active_count = 1;
                foreach($blogs AS $blog)
                {
                    $externalDomain = getExternalDomainByBlogId($blog->userblog_id);
                    $html .= '<tr>';
                    $html .= '<td data-title="Sr. No." class="srno">'.$active_count.'</td>';
                    $html .= '<td data-title="Site Name">'.$blog->blogname.'</td>';
                    $html .= '<td data-title="Site URL">';
                    $html .= '<ol>';
                    $html .= '<li><a href="'.$blog->siteurl.'" title="'.$blog->blogname.'" target="_blank">'.$blog->siteurl.'</a></li>';
                    if(isset($externalDomain) && $externalDomain!="")
                    {
                        $html .= '<li><a href="http://'.$externalDomain.'" title="'.$blog->blogname.'" target="_blank">http://'.$externalDomain.'</a></li>';
                    }
                    $html .= '</td>';
                    $html .= '<td data-title="Action">';
                   // $html .= '<input class="listblog_edit" type="submit" name="edit_site" value="Edit"/>';
                    $html .= '<input data-id="'.$blog->userblog_id.'" class="listblog_delete button" data-sending-label="Deleting..." type="submit" name="delete_site" value="Delete"/>';
                    $html .= '<input id="listblog_id" type="hidden" name="blog_id" value="'.$blog->userblog_id.'"/>';
                    $html .= '</td>';
                    $html .= '</tr>';
                    $active_count++;
                }
            $html .= '</tbody>';
            $html .= '</table>';
            $html .= '</div>';

            /*$page = $_GET['page'];
            $limit = get_option('posts_per_page');
            $total_pages = count($blogs);
            if($page) {
                $start = ($page - 1) * $limit; 
            }
            else
            {
		$start = 0;
            }
            if ($page == 0) $page = 1;
            $prev = $page - 1;
            $next = $page + 1;
            $lastpage = ceil($total_pages/$limit);

            if($lastpage > 1)
            {	
                $html .= "<div class=\"pagination\">";
                //previous button
                if ($page > 1) 
                    $html.= "<a href=\"$targetpage?page=$prev\"> previous</a>";
                else
                    $html.= "<span class=\"disabled\">previous</span>";	

                //pages	
                if ($lastpage < 7 + ($adjacents * 2))
                {	
                    for ($counter = 1; $counter <= $lastpage; $counter++)
                    {
                        if ($counter == $page)
                            $html.= "<span class=\"current\">$counter</span>";
                        else
                            $html.= "<a href=\"$targetpage?page=$counter\">$counter</a>";					
                    }
                }
                elseif($lastpage > 5 + ($adjacents * 2))
                {
                    //close to beginning; only hide later pages
                    if($page < 1 + ($adjacents * 2))		
                    {
                        for ($counter = 1; $counter < 4 + ($adjacents * 2); $counter++)
                        {
                            if ($counter == $page)
                                $html.= "<span class=\"current\">$counter</span>";
                            else
                                $html.= "<a href=\"$targetpage?page=$counter\">$counter</a>";					
                        }
                        $html.= "...";
                        $html.= "<a href=\"$targetpage?page=$lpm1\">$lpm1</a>";
                        $html.= "<a href=\"$targetpage?page=$lastpage\">$lastpage</a>";		
                    }
                    elseif($lastpage - ($adjacents * 2) > $page && $page > ($adjacents * 2))
                    {
                        $html.= "<a href=\"$targetpage?page=1\">1</a>";
                        $html.= "<a href=\"$targetpage?page=2\">2</a>";
                        $html.= "...";
                        for ($counter = $page - $adjacents; $counter <= $page + $adjacents; $counter++)
                        {
                            if ($counter == $page)
                                $html.= "<span class=\"current\">$counter</span>";
                            else
                                $html.= "<a href=\"$targetpage?page=$counter\">$counter</a>";					
                        }
                        $html.= "...";
                        $html.= "<a href=\"$targetpage?page=$lpm1\">$lpm1</a>";
                        $html.= "<a href=\"$targetpage?page=$lastpage\">$lastpage</a>";		
                    }
                    else
                    {
                        $html.= "<a href=\"$targetpage?page=1\">1</a>";
                        $html.= "<a href=\"$targetpage?page=2\">2</a>";
                        $html.= "...";
                        for ($counter = $lastpage - (2 + ($adjacents * 2)); $counter <= $lastpage; $counter++)
                        {
                            if ($counter == $page)
                                $html.= "<span class=\"current\">$counter</span>";
                            else
                                $html.= "<a href=\"$targetpage?page=$counter\">$counter</a>";					
                        }
                    }
                }
                //next button
                if ($page < $counter - 1) 
                    $html.= "<a href=\"$targetpage?page=$next\">next </a>";
                else
                    $html.= "<span class=\"disabled\">next </span>";
                $html.= "</div>\n";		
            }*/

        }
        else
        {
            $html .= '<p>'.__('No Active Sites found.','mism').'</p>';
        }
    }
    elseif($atts['type']=="all")
    {
        $blogs = get_blogs_of_user(get_current_user_id(),false);
        
        $html .= '<table class="blog-list-container '.$atts['type'].'">';
        if(count($blogs)>0)
        {
            $html .= '<h3>'.$atts['title'].'</h3>';
            
            $html .= '<thead class="blog-list-title">';
                $html .= '<th>'.__('Sr. No.','mism').'</th>';
                $html .= '<th>'.__('Site Name','mism').'</th>';
                $html .= '<th>'.__('Site URL','mism').'</th>';
                $html .= '<th>'.__('Link','mism').'</th>';
            $html .= '</thead>';
            
            $html .= '<tbody>';
                $active_count = 1;
                foreach($blogs AS $blog)
                {
                    if($blog==0)
                    {
                        $html .= '<tr>';
                        $html .= '<td>'.$active_count.'</td>';
                        $html .= '<td>'.$blog->blogname.'</td>';
                        $html .= '<td>'.$blog->siteurl.'</td>';
                        $html .= '<td>'.'<a href="'.$blog->siteurl.'" target="_blank">'.__('Visit Site','mism').'</a>'.'</td>';
                        $html .= '</tr>';
                        $active_count++;
                    }
                }
            $html .= '</tbody>';
            $html .= '</table>'; 
        }
        else
        {
            $html .= '<p>'.__('No Active Sites found.','mism').'</p>';
        }
    }
    elseif($atts['type']=="delete")
    {
        $blogs = get_blogs_of_user(get_current_user_id(),false);
        
        $html .= '<table class="blog-list-container '.$atts['type'].'">';
        if(count($blogs)>0)
        {
            $html .= '<h3>'.$atts['title'].'</h3>';
            
            $html .= '<thead class="blog-list-title">';
                $html .= '<th>'.__('Sr. No.','mism').'</th>';
                $html .= '<th>'.__('Site Name','mism').'</th>';
                $html .= '<th>'.__('Site URL','mism').'</th>';
                $html .= '<th>'.__('Link','mism').'</th>';
            $html .= '</thead>';
            
            $html .= '<tbody>';
                $active_count = 1;
                foreach($blogs AS $blog)
                {

                    $html .= '<tr>';
                    $html .= '<td>'.$active_count.'</td>';
                    $html .= '<td>'.$blog->blogname.'</td>';
                    $html .= '<td>'.$blog->siteurl.'</td>';
                    $html .= '<td>'.'<a href="'.$blog->siteurl.'" target="_blank">'.__('Visit Site','mism').'</a>'.'</td>';
                    $html .= '</tr>';
                    $active_count++;
                }
            $html .= '</tbody>';
            $html .= '</table>'; 
        }
        else
        {
            $html .= '<p>'.__('No Active Sites found.','mism').'</p>';
        }
    }
    
    return $html;
}


?>
